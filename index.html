<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¼ë””ì˜¤ ì‚¬ì—°í•¨</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
:root {
  --bg:#0d0d0d; --surface:#161616; --card:#1e1e1e; --border:#2a2a2a;
  --red:#e84040; --gold:#f5c842; --text:#f0f0f0; --muted:#888; --faint:#444;
  --green:#3ecf7a; --blue:#7aadff; --purple:#a78bfa;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* HEADER */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 2rem;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;}
.logo{display:flex;align-items:center;gap:0.8rem;}
.on-air{background:var(--red);color:#fff;font-size:0.65rem;font-weight:700;padding:0.25rem 0.6rem;border-radius:4px;letter-spacing:0.15em;animation:blink 1.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}
.logo-text{font-family:'Black Han Sans',sans-serif;font-size:1.3rem;color:var(--gold);}
.header-tabs{display:flex;gap:0.4rem;}
.htab{padding:0.45rem 1.1rem;border-radius:6px;border:1px solid transparent;background:none;color:var(--muted);font-family:'Noto Sans KR',sans-serif;font-size:0.85rem;cursor:pointer;transition:all 0.2s;}
.htab:hover{color:var(--text);border-color:var(--border);}
.htab.active{background:var(--red);color:#fff;border-color:var(--red);}

/* MAIN */
main{max-width:900px;margin:0 auto;padding:2.5rem 1.5rem;}
.page{display:none;}
.page.active{display:block;animation:fadeUp 0.4s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* FORM */
.page-title{margin-bottom:2rem;}
.page-title h1{font-family:'Black Han Sans',sans-serif;font-size:1.8rem;color:var(--gold);}
.page-title p{color:var(--muted);font-size:0.9rem;margin-top:0.4rem;}
.form-section{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:2rem;margin-bottom:1.2rem;}
.section-label{font-size:0.75rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.field{margin-bottom:1rem;}
.field:last-child{margin-bottom:0;}
.field label{display:block;font-size:0.82rem;color:var(--muted);margin-bottom:0.4rem;}
input[type="text"],textarea,select{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:0.92rem;outline:none;transition:border-color 0.2s;}
input[type="text"]:focus,textarea:focus,select:focus{border-color:var(--red);}
select{cursor:pointer;}select option{background:var(--card);}
textarea{min-height:160px;resize:vertical;line-height:1.7;}

/* TAGS */
.tag-grid{display:flex;flex-wrap:wrap;gap:0.5rem;}
.tag{padding:0.38rem 0.9rem;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-size:0.82rem;cursor:pointer;transition:all 0.2s;user-select:none;}
.tag:hover{border-color:var(--faint);color:var(--text);}
.tag.active{background:var(--red);border-color:var(--red);color:#fff;}

/* VOICE */
.voice-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1.2rem;}
.voice-hint{font-size:0.8rem;color:var(--muted);margin-bottom:1rem;text-align:center;}
.voice-controls{display:flex;align-items:center;justify-content:center;gap:0.8rem;flex-wrap:wrap;}
.btn{display:inline-flex;align-items:center;gap:0.4rem;padding:0.65rem 1.3rem;border-radius:8px;border:1px solid transparent;font-family:'Noto Sans KR',sans-serif;font-size:0.88rem;cursor:pointer;transition:all 0.2s;font-weight:500;}
.btn-red{background:var(--red);color:#fff;}
.btn-red:hover{background:#c93232;}
.btn-red.recording{background:#c0392b;animation:recPulse 1s infinite;}
@keyframes recPulse{0%,100%{box-shadow:0 0 0 0 rgba(232,64,64,0.5)}50%{box-shadow:0 0 0 8px rgba(232,64,64,0)}}
.btn-ghost{background:none;border-color:var(--border);color:var(--muted);}
.btn-ghost:hover{border-color:var(--faint);color:var(--text);}
.btn-green{background:var(--green);color:#000;}
.btn-green:hover{background:#2db865;}
.btn-blue{background:var(--blue);color:#000;}
.btn-blue:hover{background:#5a9aff;}
.btn:disabled{opacity:0.35;cursor:not-allowed;}
.rec-timer{font-size:0.9rem;font-weight:700;color:var(--red);letter-spacing:0.08em;display:none;min-width:48px;}
.audio-wrap{margin-top:1rem;}
audio{width:100%;border-radius:8px;}
.upload-zone{margin-top:0.8rem;border:1px dashed var(--border);border-radius:8px;padding:1rem;text-align:center;cursor:pointer;transition:all 0.2s;}
.upload-zone:hover{border-color:var(--faint);}
.upload-zone input{display:none;}
.upload-zone p{font-size:0.82rem;color:var(--muted);}
.fname{color:var(--green);margin-top:0.3rem;}

/* SUBMIT */
.submit-bar{display:flex;justify-content:flex-end;margin-top:1.5rem;}
.btn-submit{padding:0.85rem 2.5rem;background:var(--red);color:#fff;border:none;border-radius:10px;font-family:'Noto Sans KR',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.25s;display:flex;align-items:center;gap:0.5rem;}
.btn-submit:hover{background:#c93232;transform:translateY(-2px);box-shadow:0 6px 20px rgba(232,64,64,0.3);}
.btn-submit:disabled{opacity:0.5;cursor:not-allowed;transform:none;}

/* SUCCESS */
.success-screen{display:none;text-align:center;padding:4rem 2rem;}
.success-screen .icon{font-size:3.5rem;margin-bottom:1rem;}
.success-screen h2{font-family:'Black Han Sans',sans-serif;font-size:1.8rem;color:var(--gold);margin-bottom:0.8rem;}
.success-screen p{color:var(--muted);line-height:1.7;font-size:0.95rem;}

/* ADMIN */
.admin-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:0.8rem;}
.admin-top h2{font-family:'Black Han Sans',sans-serif;font-size:1.5rem;color:var(--gold);}
.admin-actions{display:flex;gap:0.5rem;flex-wrap:wrap;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:0.8rem;margin-bottom:1.8rem;}
.stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;text-align:center;}
.stat .n{font-family:'Black Han Sans',sans-serif;font-size:1.8rem;color:var(--red);}
.stat .l{font-size:0.75rem;color:var(--muted);margin-top:0.2rem;}

/* ANALYSIS TABS */
.analysis-tabs{display:flex;gap:0.4rem;margin-bottom:1.5rem;border-bottom:1px solid var(--border);padding-bottom:0.8rem;flex-wrap:wrap;}
.atab{padding:0.4rem 1rem;border-radius:6px;border:1px solid transparent;background:none;color:var(--muted);font-family:'Noto Sans KR',sans-serif;font-size:0.85rem;cursor:pointer;transition:all 0.2s;}
.atab.active{background:var(--surface);border-color:var(--border);color:var(--text);}
.atab:hover:not(.active){color:var(--text);}
.analysis-panel{display:none;}
.analysis-panel.active{display:block;}

/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;margin-bottom:1.5rem;}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.2rem;}
.chart-card h3{font-size:0.85rem;color:var(--muted);margin-bottom:1rem;text-transform:uppercase;letter-spacing:0.08em;}
.chart-wrap{position:relative;height:200px;}

/* KEYWORD */
.keyword-grid{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem;}
.kw-tag{padding:0.3rem 0.8rem;border-radius:20px;background:var(--surface);border:1px solid var(--border);font-size:0.82rem;display:flex;align-items:center;gap:0.4rem;}
.kw-count{background:var(--red);color:#fff;border-radius:10px;padding:0.1rem 0.4rem;font-size:0.72rem;font-weight:700;}

/* FILTER & LIST */
.filter-bar{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1.2rem;}
.filter-chip{padding:0.35rem 0.9rem;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-size:0.8rem;cursor:pointer;transition:all 0.2s;}
.filter-chip.active{background:var(--red);border-color:var(--red);color:#fff;}
.story-list{display:flex;flex-direction:column;gap:0.7rem;}
.story-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1.2rem 1.4rem;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;}
.story-card::after{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--red);opacity:0;transition:opacity 0.2s;}
.story-card:hover{border-color:var(--faint);transform:translateX(3px);}
.story-card:hover::after{opacity:1;}
.card-top{display:flex;align-items:center;gap:0.6rem;margin-bottom:0.5rem;flex-wrap:wrap;}
.sender-name{font-weight:700;font-size:0.92rem;}
.badge{display:inline-block;padding:0.18rem 0.55rem;border-radius:4px;font-size:0.72rem;font-weight:700;}
.badge-text{background:rgba(90,140,220,0.15);color:var(--blue);}
.badge-voice{background:rgba(232,64,64,0.15);color:#ff8080;}
.badge-cat{background:rgba(245,200,66,0.1);color:var(--gold);}
.badge-emo{background:rgba(62,207,122,0.1);color:var(--green);}
.badge-ai{background:rgba(167,139,250,0.15);color:var(--purple);}
.card-time{margin-left:auto;font-size:0.75rem;color:var(--faint);}
.card-preview{font-size:0.88rem;color:var(--muted);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.empty{text-align:center;padding:4rem 2rem;color:var(--muted);}
.empty .icon{font-size:2.5rem;margin-bottom:1rem;}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.overlay.open{display:flex;}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;width:90%;max-width:560px;max-height:80vh;overflow-y:auto;padding:2rem;animation:fadeUp 0.3s ease;}
.modal-head{display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:1rem;border-bottom:1px solid var(--border);margin-bottom:1.2rem;}
.modal-head h3{font-family:'Black Han Sans',sans-serif;font-size:1.1rem;color:var(--gold);}
.close-x{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;transition:color 0.2s;}
.close-x:hover{color:var(--text);}
.modal-badges{display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.5rem;}
.story-text{font-size:0.95rem;line-height:1.8;white-space:pre-wrap;color:var(--text);}
.modal-meta{margin-top:1rem;font-size:0.78rem;color:var(--faint);}

/* AI ë¶„ì„ ë°•ìŠ¤ */
.ai-box{background:rgba(167,139,250,0.08);border:1px solid rgba(167,139,250,0.2);border-radius:8px;padding:1rem;margin-top:1rem;}
.ai-box .ai-label{font-size:0.75rem;color:var(--purple);font-weight:700;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:0.4rem;}
.ai-box p{font-size:0.88rem;color:var(--text);line-height:1.6;}

/* SPINNER */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* TOAST */
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(20px);background:#222;border:1px solid var(--border);color:var(--text);padding:0.7rem 1.5rem;border-radius:8px;font-size:0.88rem;opacity:0;transition:all 0.3s;z-index:300;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(max-width:600px){
  .row2{grid-template-columns:1fr}
  .stats-row{grid-template-columns:repeat(2,1fr)}
  .charts-grid{grid-template-columns:1fr}
  .form-section{padding:1.3rem}
}
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="on-air">ON AIR</span>
    <span class="logo-text">ğŸ“» ë¼ë””ì˜¤ ì‚¬ì—°í•¨</span>
  </div>
  <div class="header-tabs">
    <button class="htab active" onclick="showPage('submit',this)">ì‚¬ì—° ë³´ë‚´ê¸°</button>
    <button class="htab" onclick="showPage('admin',this)">ğŸ“‹ ê´€ë¦¬ì</button>
  </div>
</header>

<main>

<!-- â•â• ì‚¬ì—° ë³´ë‚´ê¸° â•â• -->
<div class="page active" id="page-submit">
  <div class="page-title">
    <h1>ì‚¬ì—° ë³´ë‚´ê¸°</h1>
    <p>í…ìŠ¤íŠ¸ ë˜ëŠ” ìŒì„±ìœ¼ë¡œ ë§ˆìŒì„ ì „í•´ì£¼ì„¸ìš”</p>
  </div>
  <div id="form-body">
    <div class="form-section">
      <div class="section-label">ê¸°ë³¸ ì •ë³´</div>
      <div class="row2">
        <div class="field"><label>ë³´ë‚´ëŠ” ë¶„</label><input type="text" id="f-name" placeholder="ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„"></div>
        <div class="field"><label>ì—°ë½ì²˜ (ì„ íƒ)</label><input type="text" id="f-contact" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì „í™”ë²ˆí˜¸"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="section-label">ì‚¬ì—° ë¶„ë¥˜</div>
      <div class="field">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <div class="tag-grid" id="cat-tags">
          <span class="tag" onclick="selectCat(this)">ğŸ’ ì‚¬ë‘/ì—°ì• </span>
          <span class="tag" onclick="selectCat(this)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡±</span>
          <span class="tag" onclick="selectCat(this)">ğŸ¤ ìš°ì •/ì¸ê°„ê´€ê³„</span>
          <span class="tag" onclick="selectCat(this)">ğŸ’¼ ì§ì¥/í•™ì—…</span>
          <span class="tag" onclick="selectCat(this)">ğŸ’° ëˆ/ìƒí™œ</span>
          <span class="tag" onclick="selectCat(this)">ğŸŒ¿ ê±´ê°•/ë§ˆìŒ</span>
          <span class="tag" onclick="selectCat(this)">ğŸµ ì¶”ì–µ/ì¼ìƒ</span>
          <span class="tag" onclick="selectCat(this)">âœ¨ ê¸°íƒ€</span>
        </div>
      </div>
      <div class="field" style="margin-top:1.2rem;">
        <label>ê°ì • íƒœê·¸ (ë³µìˆ˜ ì„ íƒ)</label>
        <div class="tag-grid" id="emo-tags">
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜Š ê¸°ì¨</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜¢ ìŠ¬í””</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜° ë¶ˆì•ˆ</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜¤ ë¶„ë…¸</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸŒ¸ ê°ì‚¬</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ’« í¬ë§</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜” ì™¸ë¡œì›€</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ™ ê³ ë¯¼</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜­ ê·¸ë¦¬ì›€</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ¥° ì„¤ë ˜</span>
        </div>
      </div>
    </div>
    <div class="form-section">
      <div class="section-label">í…ìŠ¤íŠ¸ ì‚¬ì—°</div>
      <div class="field"><textarea id="f-text" placeholder="ë§ˆìŒì† ì´ì•¼ê¸°ë¥¼ ììœ ë¡­ê²Œ ì¨ì£¼ì„¸ìš”..."></textarea></div>
    </div>
    <div class="form-section">
      <div class="section-label">ìŒì„± ì‚¬ì—°</div>
      <div class="voice-box">
        <p class="voice-hint">ë§ˆì´í¬ë¡œ ì§ì ‘ ë…¹ìŒí•˜ê±°ë‚˜ ìŒì„± íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
        <div class="voice-controls">
          <button class="btn btn-red" id="rec-btn" onclick="toggleRec()">ğŸ™ï¸ <span id="rec-label">ë…¹ìŒ ì‹œì‘</span></button>
          <span class="rec-timer" id="rec-timer">00:00</span>
        </div>
        <div class="audio-wrap" id="audio-preview"></div>
      </div>
      <div class="upload-zone" onclick="document.getElementById('vfile').click()">
        <input type="file" id="vfile" accept="audio/*" onchange="handleFile(this)">
        <p>ğŸ“ íŒŒì¼ ì²¨ë¶€ (.mp3 .wav .m4a .ogg)</p>
        <p class="fname" id="fname"></p>
      </div>
    </div>
    <div class="submit-bar">
      <button class="btn-submit" id="submit-btn" onclick="submitStory()">ğŸ“¨ ì‚¬ì—° ì „ì†¡</button>
    </div>
  </div>
  <div class="success-screen" id="success-screen">
    <div class="icon">ğŸ“»</div>
    <h2>ì‚¬ì—°ì´ ì „ë‹¬ëìŠµë‹ˆë‹¤!</h2>
    <p>ì†Œì¤‘í•œ ì´ì•¼ê¸°ë¥¼ ë³´ë‚´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br>ë°©ì†¡ì—ì„œ ì†Œê°œë  ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê¸°ëŒ€í•´ ì£¼ì„¸ìš” ğŸ¶</p>
    <br>
    <button class="btn btn-ghost" style="margin:0 auto;" onclick="resetForm()">ìƒˆ ì‚¬ì—° ë³´ë‚´ê¸°</button>
  </div>
</div>

<!-- â•â• ê´€ë¦¬ì â•â• -->
<div class="page" id="page-admin">
  <div class="admin-top">
    <h2>ì‚¬ì—° ê´€ë¦¬</h2>
    <div class="admin-actions">
      <button class="btn btn-green" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn btn-ghost" style="font-size:0.8rem;" onclick="clearAll()">ì „ì²´ ì‚­ì œ</button>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat"><div class="n" id="st-total">-</div><div class="l">ì „ì²´ ì‚¬ì—°</div></div>
    <div class="stat"><div class="n" id="st-text">-</div><div class="l">í…ìŠ¤íŠ¸</div></div>
    <div class="stat"><div class="n" id="st-voice">-</div><div class="l">ìŒì„±</div></div>
    <div class="stat"><div class="n" id="st-today">-</div><div class="l">ì˜¤ëŠ˜ ì ‘ìˆ˜</div></div>
  </div>

  <!-- ë¶„ì„ íƒ­ -->
  <div class="analysis-tabs">
    <button class="atab active" onclick="showAnalysis('list',this)">ğŸ“‹ ì‚¬ì—° ëª©ë¡</button>
    <button class="atab" onclick="showAnalysis('chart',this)">ğŸ“Š í†µê³„ ì°¨íŠ¸</button>
    <button class="atab" onclick="showAnalysis('keyword',this)">ğŸ” í‚¤ì›Œë“œ ë¶„ì„</button>
  </div>

  <!-- ì‚¬ì—° ëª©ë¡ -->
  <div class="analysis-panel active" id="panel-list">
    <div class="filter-bar">
      <span class="filter-chip active" onclick="setFilter('ì „ì²´',this)">ì „ì²´</span>
      <span class="filter-chip" onclick="setFilter('í…ìŠ¤íŠ¸',this)">ğŸ“ í…ìŠ¤íŠ¸ë§Œ</span>
      <span class="filter-chip" onclick="setFilter('ìŒì„±',this)">ğŸ™ï¸ ìŒì„±ë§Œ</span>
      <span class="filter-chip" onclick="setFilter('ğŸ’ ì‚¬ë‘/ì—°ì• ',this)">ğŸ’ ì‚¬ë‘/ì—°ì• </span>
      <span class="filter-chip" onclick="setFilter('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡±',this)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡±</span>
      <span class="filter-chip" onclick="setFilter('ğŸŒ¿ ê±´ê°•/ë§ˆìŒ',this)">ğŸŒ¿ ê±´ê°•</span>
    </div>
    <div class="story-list" id="story-list">
      <div class="empty"><div class="icon">â³</div><p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
    </div>
  </div>

  <!-- í†µê³„ ì°¨íŠ¸ -->
  <div class="analysis-panel" id="panel-chart">
    <div class="charts-grid">
      <div class="chart-card">
        <h3>ì¹´í…Œê³ ë¦¬ë³„ ì‚¬ì—° ìˆ˜</h3>
        <div class="chart-wrap"><canvas id="chart-cat"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>ê°ì • ë¶„í¬</h3>
        <div class="chart-wrap"><canvas id="chart-emo"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>ì¼ë³„ ì‚¬ì—° ì ‘ìˆ˜</h3>
        <div class="chart-wrap"><canvas id="chart-daily"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>í…ìŠ¤íŠ¸ vs ìŒì„±</h3>
        <div class="chart-wrap"><canvas id="chart-type"></canvas></div>
      </div>
    </div>
  </div>

  <!-- í‚¤ì›Œë“œ ë¶„ì„ -->
  <div class="analysis-panel" id="panel-keyword">
    <div class="form-section">
      <div class="section-label">ìì£¼ ë“±ì¥í•˜ëŠ” ë‹¨ì–´ TOP 30</div>
      <div class="keyword-grid" id="keyword-grid">
        <p style="color:var(--muted);font-size:0.88rem;">ì‚¬ì—° ëª©ë¡ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.</p>
      </div>
    </div>
    <div class="form-section" style="margin-top:1rem;">
      <div class="section-label">AI ê°ì • ìë™ ë¶„ë¥˜ ê²°ê³¼</div>
      <p style="font-size:0.82rem;color:var(--muted);margin-bottom:1rem;">ì‚¬ì—° í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•´ AIê°€ ê°ì •ì„ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>
      <button class="btn btn-blue" onclick="runAIAnalysis()" id="ai-btn">ğŸ¤– AI ë¶„ì„ ì‹¤í–‰</button>
      <div id="ai-results" style="margin-top:1rem;"></div>
    </div>
  </div>
</div>

</main>

<!-- ëª¨ë‹¬ -->
<div class="overlay" id="overlay" onclick="maybeClose(event)">
  <div class="modal">
    <div class="modal-head">
      <div>
        <h3 id="m-name"></h3>
        <div class="modal-badges" id="m-badges"></div>
      </div>
      <button class="close-x" onclick="closeModal()">âœ•</button>
    </div>
    <div id="m-text-area"></div>
    <div id="m-audio-area"></div>
    <div id="m-ai-area"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;">
      <p class="modal-meta" id="m-time"></p>
      <button class="btn btn-ghost" style="font-size:0.8rem;" onclick="deleteStory()">ğŸ—‘ï¸ ì‚­ì œ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';
let selCat='', selEmos=[];
let recorder=null, chunks=[], recBlob=null, uploadedFile=null;
let timerInt=null, secs=0, recActive=false;
let activeFilter='ì „ì²´', currentModalId=null;
let allStories=[];
let charts={};

// â”€â”€â”€ PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.htab').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  btn.classList.add('active');
  if(id==='admin') loadAdmin();
}

function showAnalysis(id,btn){
  document.querySelectorAll('.analysis-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.atab').forEach(b=>b.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  btn.classList.add('active');
  if(id==='chart') renderCharts();
  if(id==='keyword') renderKeywords();
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg,d=2500){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),d);
}

// â”€â”€â”€ TAGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectCat(el){
  document.querySelectorAll('#cat-tags .tag').forEach(t=>t.classList.remove('active'));
  el.classList.add('active'); selCat=el.textContent.trim();
}
function toggleEmo(el){
  el.classList.toggle('active');
  const t=el.textContent.trim();
  if(el.classList.contains('active')) selEmos.push(t);
  else selEmos=selEmos.filter(e=>e!==t);
}

// â”€â”€â”€ RECORDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleRec(){
  if(!recActive){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      recorder=new MediaRecorder(stream); chunks=[];
      recorder.ondataavailable=e=>chunks.push(e.data);
      recorder.onstop=()=>{
        recBlob=new Blob(chunks,{type:'audio/webm'});
        const url=URL.createObjectURL(recBlob);
        document.getElementById('audio-preview').innerHTML=`<audio controls src="${url}"></audio>`;
        stream.getTracks().forEach(t=>t.stop());
      };
      recorder.start(); recActive=true;
      document.getElementById('rec-btn').classList.add('recording');
      document.getElementById('rec-label').textContent='ë…¹ìŒ ì¤‘ì§€';
      secs=0; document.getElementById('rec-timer').style.display='inline';
      timerInt=setInterval(()=>{
        secs++;
        const m=String(Math.floor(secs/60)).padStart(2,'0');
        const s=String(secs%60).padStart(2,'0');
        document.getElementById('rec-timer').textContent=`${m}:${s}`;
      },1000);
    }catch(e){alert('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');}
  }else{
    recorder.stop(); recActive=false; clearInterval(timerInt);
    document.getElementById('rec-btn').classList.remove('recording');
    document.getElementById('rec-label').textContent='ë…¹ìŒ ì‹œì‘';
    document.getElementById('rec-timer').style.display='none';
  }
}

function handleFile(input){
  const f=input.files[0]; if(!f) return;
  uploadedFile=f; document.getElementById('fname').textContent='âœ… '+f.name;
}

// â”€â”€â”€ SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitStory(){
  const text=document.getElementById('f-text').value.trim();
  const name=document.getElementById('f-name').value.trim();
  const contact=document.getElementById('f-contact').value.trim();
  if(!text&&!recBlob&&!uploadedFile){showToast('â— í…ìŠ¤íŠ¸ ë˜ëŠ” ìŒì„± ì‚¬ì—°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  const btn=document.getElementById('submit-btn');
  btn.disabled=true; btn.innerHTML='<div class="spinner"></div> ì „ì†¡ ì¤‘...';
  const fd=new FormData();
  fd.append('name',name||'ìµëª…'); fd.append('contact',contact);
  fd.append('text',text); fd.append('category',selCat);
  fd.append('emotions',JSON.stringify(selEmos));
  const vs=recBlob||uploadedFile;
  if(vs){const ext=vs instanceof File?vs.name.split('.').pop():'webm'; fd.append('voice',vs,`voice.${ext}`);}
  try{
    const res=await fetch(`${API}/api/stories`,{method:'POST',body:fd});
    const data=await res.json();
    if(data.success){
      document.getElementById('form-body').style.display='none';
      document.getElementById('success-screen').style.display='block';
    }else{showToast('â— '+(data.error||'ì˜¤ë¥˜'));btn.disabled=false;btn.innerHTML='ğŸ“¨ ì‚¬ì—° ì „ì†¡';}
  }catch(e){showToast('â— ì„œë²„ ì—°ê²° ì‹¤íŒ¨');btn.disabled=false;btn.innerHTML='ğŸ“¨ ì‚¬ì—° ì „ì†¡';}
}

function resetForm(){
  document.getElementById('f-text').value='';
  document.getElementById('f-name').value='';
  document.getElementById('f-contact').value='';
  document.getElementById('audio-preview').innerHTML='';
  document.getElementById('fname').textContent='';
  document.querySelectorAll('.tag').forEach(t=>t.classList.remove('active'));
  selCat=''; selEmos=[]; recBlob=null; uploadedFile=null;
  const btn=document.getElementById('submit-btn');
  btn.disabled=false; btn.innerHTML='ğŸ“¨ ì‚¬ì—° ì „ì†¡';
  document.getElementById('form-body').style.display='block';
  document.getElementById('success-screen').style.display='none';
}

// â”€â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAdmin(){
  await loadStats();
  await loadAllStories();
  renderList();
}

async function loadStats(){
  try{
    const res=await fetch(`${API}/api/stats`);
    const d=await res.json();
    document.getElementById('st-total').textContent=d.total;
    document.getElementById('st-text').textContent=d.textCount;
    document.getElementById('st-voice').textContent=d.voiceCount;
    document.getElementById('st-today').textContent=d.todayCount;
  }catch(e){}
}

async function loadAllStories(){
  try{
    const res=await fetch(`${API}/api/stories?limit=500`);
    const {items}=await res.json();
    allStories=items;
  }catch(e){allStories=[];}
}

function renderList(){
  const filtered=allStories.filter(s=>{
    if(activeFilter==='ì „ì²´') return true;
    if(activeFilter==='í…ìŠ¤íŠ¸') return s.text&&!s.hasVoice;
    if(activeFilter==='ìŒì„±') return s.hasVoice;
    return s.category===activeFilter;
  });
  const list=document.getElementById('story-list');
  if(!filtered.length){list.innerHTML=`<div class="empty"><div class="icon">ğŸ“­</div><p>í•´ë‹¹í•˜ëŠ” ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤</p></div>`;return;}
  list.innerHTML=filtered.map(s=>{
    const d=new Date(s.timestamp);
    const t=d.toLocaleDateString('ko-KR')+' '+d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    const tb=s.text?`<span class="badge badge-text">í…ìŠ¤íŠ¸</span>`:'';
    const vb=s.hasVoice?`<span class="badge badge-voice">ğŸ™ï¸ ìŒì„±</span>`:'';
    const cb=s.category?`<span class="badge badge-cat">${s.category}</span>`:'';
    const eb=(s.emotions||[]).slice(0,2).map(e=>`<span class="badge badge-emo">${e}</span>`).join('');
    const ab=s.aiEmotion?`<span class="badge badge-ai">ğŸ¤– ${s.aiEmotion}</span>`:'';
    const preview=s.text||(s.hasVoice?'(ìŒì„± ì‚¬ì—°)':'');
    return `<div class="story-card" onclick="openModal('${s.id}')">
      <div class="card-top"><span class="sender-name">${s.name}</span>${tb}${vb}${cb}${eb}${ab}<span class="card-time">${t}</span></div>
      <div class="card-preview">${preview}</div>
    </div>`;
  }).join('');
}

function setFilter(val,el){
  activeFilter=val;
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); renderList();
}

async function clearAll(){
  if(!confirm('ëª¨ë“  ì‚¬ì—°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch(`${API}/api/stories`,{method:'DELETE'});
  showToast('âœ… ì „ì²´ ì‚­ì œ ì™„ë£Œ'); allStories=[]; loadAdmin();
}

// â”€â”€â”€ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadExcel(){
  if(!allStories.length){showToast('â— ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  const rows=allStories.map(s=>({
    'ë²ˆí˜¸': s.id.slice(0,8),
    'ì´ë¦„': s.name,
    'ì—°ë½ì²˜': s.contact||'',
    'ì¹´í…Œê³ ë¦¬': s.category||'',
    'ê°ì •íƒœê·¸': (s.emotions||[]).join(', '),
    'AIê°ì •ë¶„ë¥˜': s.aiEmotion||'',
    'ì‚¬ì—°ë‚´ìš©': s.text||'(ìŒì„±ì‚¬ì—°)',
    'ìŒì„±ì—¬ë¶€': s.hasVoice?'O':'X',
    'ì ‘ìˆ˜ì¼ì‹œ': new Date(s.timestamp).toLocaleString('ko-KR')
  }));
  const ws=XLSX.utils.json_to_sheet(rows);
  ws['!cols']=[{wch:10},{wch:12},{wch:18},{wch:14},{wch:20},{wch:12},{wch:50},{wch:8},{wch:20}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'ì‚¬ì—°ëª©ë¡');
  const date=new Date().toLocaleDateString('ko-KR').replace(/\. /g,'-').replace('.','');
  XLSX.writeFile(wb,`ë¼ë””ì˜¤ì‚¬ì—°_${date}.xlsx`);
  showToast('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
}

// â”€â”€â”€ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts(){
  if(!allStories.length) return;

  const COLORS=['#e84040','#f5c842','#3ecf7a','#7aadff','#a78bfa','#fb923c','#34d399','#f472b6'];

  // ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸
  const catMap={};
  allStories.forEach(s=>{if(s.category) catMap[s.category]=(catMap[s.category]||0)+1;});
  renderDoughnut('chart-cat', Object.keys(catMap), Object.values(catMap), COLORS);

  // ê°ì • ì°¨íŠ¸
  const emoMap={};
  allStories.forEach(s=>(s.emotions||[]).forEach(e=>{emoMap[e]=(emoMap[e]||0)+1;}));
  const emoSorted=Object.entries(emoMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
  renderBar('chart-emo', emoSorted.map(e=>e[0]), emoSorted.map(e=>e[1]), '#a78bfa');

  // ì¼ë³„ ì°¨íŠ¸
  const dayMap={};
  allStories.forEach(s=>{
    const d=new Date(s.timestamp).toLocaleDateString('ko-KR');
    dayMap[d]=(dayMap[d]||0)+1;
  });
  const daySorted=Object.entries(dayMap).sort((a,b)=>new Date(a[0])-new Date(b[0])).slice(-7);
  renderLine('chart-daily', daySorted.map(d=>d[0]), daySorted.map(d=>d[1]));

  // í…ìŠ¤íŠ¸ vs ìŒì„±
  const tCount=allStories.filter(s=>s.text&&!s.hasVoice).length;
  const vCount=allStories.filter(s=>s.hasVoice&&!s.text).length;
  const bCount=allStories.filter(s=>s.text&&s.hasVoice).length;
  renderDoughnut('chart-type',['í…ìŠ¤íŠ¸ë§Œ','ìŒì„±ë§Œ','í…ìŠ¤íŠ¸+ìŒì„±'],[tCount,vCount,bCount],['#7aadff','#e84040','#f5c842']);
}

function renderDoughnut(id, labels, data, colors){
  if(charts[id]) charts[id].destroy();
  const ctx=document.getElementById(id).getContext('2d');
  charts[id]=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#888',font:{size:11},boxWidth:12}}}}});
}

function renderBar(id, labels, data, color){
  if(charts[id]) charts[id].destroy();
  const ctx=document.getElementById(id).getContext('2d');
  charts[id]=new Chart(ctx,{type:'bar',data:{labels,datasets:[{data,backgroundColor:color,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#888',font:{size:10}}},y:{ticks:{color:'#888',stepSize:1},grid:{color:'#2a2a2a'}}}}});
}

function renderLine(id, labels, data){
  if(charts[id]) charts[id].destroy();
  const ctx=document.getElementById(id).getContext('2d');
  charts[id]=new Chart(ctx,{type:'line',data:{labels,datasets:[{data,borderColor:'#e84040',backgroundColor:'rgba(232,64,64,0.1)',tension:0.4,fill:true,pointBackgroundColor:'#e84040'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#888',font:{size:10}}},y:{ticks:{color:'#888',stepSize:1},grid:{color:'#2a2a2a'}}}}});
}

// â”€â”€â”€ í‚¤ì›Œë“œ ë¶„ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKeywords(){
  const stopWords=new Set(['ì´','ê°€','ì„','ë¥¼','ì€','ëŠ”','ì—','ì˜','ë¡œ','ìœ¼ë¡œ','ë„','ì™€','ê³¼','ì—ì„œ','í•œ','í•˜','ì´ë‹¤','ìˆë‹¤','ì—†ë‹¤','ê·¸','ê·¸ë¦¬ê³ ','í•˜ì§€ë§Œ','ê·¸ëŸ°ë°','ë•Œ','ë”','ìˆ˜','ê²ƒ','ë“¤','ì•ˆ','ëª»','ë„ˆ','ë‚˜','ìš°ë¦¬','ì €','ì œ','ê·¸ê²ƒ','ì´ê²ƒ','ì €ê²ƒ','í•©ë‹ˆë‹¤','í–ˆìŠµë‹ˆë‹¤','ì…ë‹ˆë‹¤','ìŠµë‹ˆë‹¤','í–ˆì–´','ì´ì•¼','ì´ì—ìš”','ì˜ˆìš”','í•´ìš”','í•´ì„œ','í•˜ê³ ','í–ˆê³ ','ì¸ë°','ì§€ë§Œ','ë‹ˆê¹Œ','ì—ìš”','ê±°ì•¼','í• ','í• ê²Œ','í•˜ë©´','í–ˆëŠ”ë°','ìˆì–´','ì—†ì–´','ê°™ì•„','ê°™ì€','ì¢€','ì •ë§','ë„ˆë¬´','ì§„ì§œ','ì•„ì£¼','ë§¤ìš°','ë§ì´','ì¡°ê¸ˆ','ê±°ì˜','ë³„ë¡œ','í•­ìƒ','ìê¾¸','ê³„ì†','ë‹¤ì‹œ','ë˜','ë¨¼ì €','í›„ì—','ë•Œë¬¸ì—','ìœ„í•´','í†µí•´']);
  const freq={};
  allStories.forEach(s=>{
    if(!s.text) return;
    const words=s.text.replace(/[^\w\sã„±-ã…ê°€-í£]/g,' ').split(/\s+/);
    words.forEach(w=>{
      if(w.length>=2&&!stopWords.has(w)) freq[w]=(freq[w]||0)+1;
    });
  });
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,30);
  const grid=document.getElementById('keyword-grid');
  if(!sorted.length){grid.innerHTML='<p style="color:var(--muted);font-size:0.88rem;">í…ìŠ¤íŠ¸ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤.</p>';return;}
  const maxCount=sorted[0][1];
  grid.innerHTML=sorted.map(([w,c])=>{
    const size=0.8+((c/maxCount)*0.5);
    return `<span class="kw-tag" style="font-size:${size}rem"><span>${w}</span><span class="kw-count">${c}</span></span>`;
  }).join('');
}

// â”€â”€â”€ AI ê°ì • ë¶„ë¥˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAIAnalysis(){
  const textStories=allStories.filter(s=>s.text);
  if(!textStories.length){showToast('â— ë¶„ì„í•  í…ìŠ¤íŠ¸ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤.');return;}
  const btn=document.getElementById('ai-btn');
  btn.disabled=true; btn.innerHTML='<div class="spinner"></div> AI ë¶„ì„ ì¤‘...';
  const results=[];
  for(const s of textStories.slice(0,20)){
    const emo=simpleEmotionClassify(s.text);
    s.aiEmotion=emo;
    results.push({name:s.name, text:s.text.slice(0,60)+'...', emo});
  }
  btn.disabled=false; btn.innerHTML='ğŸ¤– AI ë¶„ì„ ì¬ì‹¤í–‰';
  showToast(`âœ… ${results.length}ê°œ ì‚¬ì—° ë¶„ì„ ì™„ë£Œ!`);
  document.getElementById('ai-results').innerHTML=results.map(r=>`
    <div class="ai-box">
      <div class="ai-label">ğŸ¤– AI ë¶„ë¥˜: ${r.emo}</div>
      <p><strong>${r.name}</strong> â€” ${r.text}</p>
    </div>`).join('');
  renderList();
}

function simpleEmotionClassify(text){
  const rules=[
    ['ìŠ¬í””',['ìŠ¬í”„','ëˆˆë¬¼','ìš¸','í˜ë“¤','ê´´ë¡œ','ì™¸ë¡œ','ê·¸ë¦½','ì•„í”„','ìƒì²˜','í›„íšŒ','ë¯¸ì•ˆ','ìƒ','ë– ë‚˜','í—¤ì–´','ì´ë³„']],
    ['ê¸°ì¨',['ê¸°ì˜','í–‰ë³µ','ì¢‹ì•„','ì›ƒ','ì¦ê²','ì‹ ë‚˜','ì„¤ë ˆ','ê°ì‚¬','ê³ ë§ˆ','ì‚¬ë‘','ì˜ë','ë‹¤í–‰']],
    ['ë¶„ë…¸',['í™”ë‚˜','ì§œì¦','ì—´ë°›','ì‹«','ì–µìš¸','ë¶ˆê³µí‰','í™”ê°€','ë¶„í•˜','ë¯¸ì›Œ','ì›ë§']],
    ['ë¶ˆì•ˆ',['ê±±ì •','ë¶ˆì•ˆ','ë‘ë ¤','ë¬´ì„­','ê¸´ì¥','ì´ˆì¡°','ë–¨ë¦¬','ê²ë‚˜','ì–´ì©Œ','ëª¨ë¥´ê² ']],
    ['í¬ë§',['í¬ë§','ë°”ë¼','ê¸°ëŒ€','ê¿ˆ','ì•ìœ¼ë¡œ','ë‚˜ì•„ì§€','ì´ê²¨','ê·¹ë³µ','í•  ìˆ˜ ìˆ','ë…¸ë ¥']],
    ['ê°ì‚¬',['ê°ì‚¬','ê³ ë§ˆ','ë•ë¶„','ë°°ë ¤','ì±™ê²¨','ì‘ì›','í˜ì´','ìœ„ë¡œ','ë„ì›€']],
  ];
  const scores={};
  rules.forEach(([emo,words])=>{
    scores[emo]=words.filter(w=>text.includes(w)).length;
  });
  const top=Object.entries(scores).sort((a,b)=>b[1]-a[1])[0];
  return top&&top[1]>0?top[0]:'ì¤‘ë¦½';
}

// â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id){
  const s=allStories.find(x=>x.id===id); if(!s) return;
  currentModalId=id;
  document.getElementById('m-name').textContent=s.name+'ë‹˜ì˜ ì‚¬ì—°';
  const badges=[
    s.category?`<span class="badge badge-cat">${s.category}</span>`:'',
    ...(s.emotions||[]).map(e=>`<span class="badge badge-emo">${e}</span>`),
    s.aiEmotion?`<span class="badge badge-ai">ğŸ¤– ${s.aiEmotion}</span>`:''
  ].join('');
  document.getElementById('m-badges').innerHTML=badges;
  document.getElementById('m-text-area').innerHTML=s.text?`<p class="story-text">${s.text}</p>`:'';
  document.getElementById('m-audio-area').innerHTML=s.voiceUrl?`<audio controls src="${s.voiceUrl}" style="width:100%;margin-top:1rem;"></audio>`:'';
  document.getElementById('m-ai-area').innerHTML=s.aiEmotion?`<div class="ai-box"><div class="ai-label">ğŸ¤– AI ê°ì • ë¶„ë¥˜</div><p>${s.aiEmotion}</p></div>`:'';
  const d=new Date(s.timestamp);
  let meta=d.toLocaleString('ko-KR');
  if(s.contact) meta+=' Â· '+s.contact;
  document.getElementById('m-time').textContent=meta;
  document.getElementById('overlay').classList.add('open');
}

async function deleteStory(){
  if(!currentModalId) return;
  if(!confirm('ì´ ì‚¬ì—°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch(`${API}/api/stories/${currentModalId}`,{method:'DELETE'});
  allStories=allStories.filter(s=>s.id!==currentModalId);
  closeModal(); showToast('âœ… ì‚­ì œ ì™„ë£Œ'); loadAdmin();
}

function maybeClose(e){if(e.target===document.getElementById('overlay')) closeModal();}
function closeModal(){document.getElementById('overlay').classList.remove('open');currentModalId=null;}
</script>
</body>
</html>
