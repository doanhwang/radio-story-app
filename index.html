<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‚¬ì—° ë³´ë‚´ê¸° â€” ë¼ë””ì˜¤</title>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&family=Noto+Sans+KR:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#fdf6ee; --warm:#f0e6d3; --ink:#1c1410;
  --rust:#c0552a; --rust-light:#e8825a; --gold:#d4a843;
  --muted:#8a7562; --border:#ddd0be; --card:#faf3e8;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{
  font-family:'Noto Sans KR',sans-serif;
  background:var(--cream);
  color:var(--ink);
  min-height:100vh;
  background-image:
    radial-gradient(ellipse 80% 60% at 10% 0%, rgba(192,85,42,0.07) 0%, transparent 60%),
    radial-gradient(ellipse 60% 80% at 90% 100%, rgba(212,168,67,0.08) 0%, transparent 60%);
}

/* â”€â”€â”€ í—¤ë” â”€â”€â”€ */
.site-header {
  padding: 2rem 2rem 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.radio-badge {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  font-size: 0.78rem;
  color: var(--muted);
  letter-spacing: 0.1em;
  text-transform: uppercase;
}
.dot {
  width: 8px; height: 8px;
  background: var(--rust);
  border-radius: 50%;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:0.5;transform:scale(0.8)}
}

/* â”€â”€â”€ íˆì–´ë¡œ â”€â”€â”€ */
.hero {
  text-align: center;
  padding: 3.5rem 2rem 2rem;
  position: relative;
}
.hero::before {
  content: 'â™ª';
  position: absolute;
  top: 2rem; left: 10%;
  font-size: 4rem;
  color: rgba(192,85,42,0.06);
  animation: float 6s ease-in-out infinite;
}
.hero::after {
  content: 'â™©';
  position: absolute;
  top: 3rem; right: 12%;
  font-size: 3rem;
  color: rgba(212,168,67,0.08);
  animation: float 8s ease-in-out infinite reverse;
}
@keyframes float {
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-12px)}
}
.hero-label {
  font-size: 0.75rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--rust);
  margin-bottom: 1rem;
  font-weight: 500;
}
.hero h1 {
  font-family: 'Nanum Myeongjo', serif;
  font-size: clamp(2rem, 6vw, 3.2rem);
  font-weight: 800;
  color: var(--ink);
  line-height: 1.3;
  margin-bottom: 1rem;
}
.hero h1 em {
  font-style: normal;
  color: var(--rust);
}
.hero p {
  font-size: 1rem;
  color: var(--muted);
  line-height: 1.8;
  max-width: 420px;
  margin: 0 auto;
}

/* â”€â”€â”€ í¼ â”€â”€â”€ */
.form-wrap {
  max-width: 620px;
  margin: 0 auto;
  padding: 0 1.5rem 4rem;
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 16px rgba(28,20,16,0.05);
  transition: box-shadow 0.3s;
}
.card:hover { box-shadow: 0 4px 24px rgba(28,20,16,0.09); }

.card-title {
  font-family: 'Nanum Myeongjo', serif;
  font-size: 1rem;
  font-weight: 700;
  color: var(--rust);
  margin-bottom: 1.2rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }

.field { margin-bottom: 0.9rem; }
.field:last-child { margin-bottom: 0; }
.field label {
  display: block;
  font-size: 0.8rem;
  color: var(--muted);
  margin-bottom: 0.35rem;
  font-weight: 500;
}
input[type="text"], textarea {
  width: 100%;
  background: #fff;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 0.75rem 1rem;
  color: var(--ink);
  font-family: 'Noto Sans KR', sans-serif;
  font-size: 0.92rem;
  outline: none;
  transition: border-color 0.25s, box-shadow 0.25s;
}
input[type="text"]:focus, textarea:focus {
  border-color: var(--rust);
  box-shadow: 0 0 0 3px rgba(192,85,42,0.1);
}
textarea { min-height: 180px; resize: vertical; line-height: 1.75; }

/* â”€â”€â”€ íƒœê·¸ â”€â”€â”€ */
.tag-grid { display: flex; flex-wrap: wrap; gap: 0.45rem; }
.tag {
  padding: 0.35rem 0.85rem;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  background: #fff;
  color: var(--muted);
  font-size: 0.82rem;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
}
.tag:hover { border-color: var(--rust-light); color: var(--rust); }
.tag.active { background: var(--rust); border-color: var(--rust); color: #fff; }

/* â”€â”€â”€ ìŒì„± â”€â”€â”€ */
.voice-inner {
  background: #fff;
  border: 1.5px dashed var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
}
.voice-hint { font-size: 0.82rem; color: var(--muted); margin-bottom: 1rem; line-height: 1.6; }
.voice-controls { display: flex; align-items: center; justify-content: center; gap: 0.7rem; flex-wrap: wrap; }
.btn {
  display: inline-flex; align-items: center; gap: 0.4rem;
  padding: 0.65rem 1.4rem; border-radius: 10px;
  border: 1.5px solid transparent;
  font-family: 'Noto Sans KR', sans-serif;
  font-size: 0.88rem; cursor: pointer; transition: all 0.2s; font-weight: 500;
}
.btn-rust { background: var(--rust); color: #fff; }
.btn-rust:hover { background: #a8451e; transform: translateY(-1px); }
.btn-rust.recording { animation: recPulse 1s infinite; }
@keyframes recPulse {
  0%,100%{box-shadow:0 0 0 0 rgba(192,85,42,0.5)}
  50%{box-shadow:0 0 0 10px rgba(192,85,42,0)}
}
.btn-outline {
  background: #fff; border-color: var(--border); color: var(--muted);
}
.btn-outline:hover { border-color: var(--rust-light); color: var(--rust); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
.rec-timer { font-size: 0.9rem; font-weight: 700; color: var(--rust); display: none; min-width: 48px; }
audio { width: 100%; border-radius: 8px; margin-top: 1rem; }

.upload-zone {
  margin-top: 0.8rem;
  border: 1.5px dashed var(--border);
  border-radius: 10px;
  padding: 1rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}
.upload-zone:hover { border-color: var(--rust-light); background: rgba(192,85,42,0.02); }
.upload-zone input { display: none; }
.upload-zone p { font-size: 0.82rem; color: var(--muted); }
.fname { color: var(--rust); margin-top: 0.3rem; font-size: 0.82rem; }

/* â”€â”€â”€ ì œì¶œ ë²„íŠ¼ â”€â”€â”€ */
.submit-btn {
  width: 100%;
  padding: 1.1rem;
  background: var(--rust);
  color: #fff;
  border: none;
  border-radius: 14px;
  font-family: 'Nanum Myeongjo', serif;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  letter-spacing: 0.05em;
}
.submit-btn:hover {
  background: #a8451e;
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(192,85,42,0.3);
}
.submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

/* â”€â”€â”€ ì„±ê³µ â”€â”€â”€ */
.success-screen {
  display: none;
  text-align: center;
  padding: 5rem 2rem;
  max-width: 480px;
  margin: 0 auto;
}
.success-icon { font-size: 4rem; margin-bottom: 1.5rem; }
.success-screen h2 {
  font-family: 'Nanum Myeongjo', serif;
  font-size: 2rem;
  font-weight: 800;
  color: var(--ink);
  margin-bottom: 0.8rem;
}
.success-screen p { color: var(--muted); line-height: 1.8; }

/* â”€â”€â”€ ìŠ¤í”¼ë„ˆ â”€â”€â”€ */
.spinner {
  display: inline-block; width: 18px; height: 18px;
  border: 2px solid rgba(255,255,255,0.4);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€ */
.toast {
  position: fixed; bottom: 2rem; left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--ink); color: #fff;
  padding: 0.75rem 1.5rem; border-radius: 10px;
  font-size: 0.88rem; opacity: 0;
  transition: all 0.3s; z-index: 300; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

@media(max-width:520px){
  .row2 { grid-template-columns: 1fr; }
  .hero h1 { font-size: 1.8rem; }
  .card { padding: 1.4rem; }
}
</style>
</head>
<body>

<header class="site-header">
  <div class="radio-badge">
    <span class="dot"></span>
    <span>ON AIR</span>
  </div>
  <div style="font-size:0.78rem;color:var(--muted);">ğŸ“» ë¼ë””ì˜¤ ì‚¬ì—°í•¨</div>
</header>

<section class="hero">
  <p class="hero-label">Radio Story</p>
  <h1>ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼<br><em>ë“¤ë ¤ì£¼ì„¸ìš”</em></h1>
  <p>ì†Œì¤‘í•œ ì‚¬ì—°ì„ í…ìŠ¤íŠ¸ë‚˜ ìŒì„±ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”.<br>ë°©ì†¡ì—ì„œ ì—¬ëŸ¬ë¶„ì˜ ëª©ì†Œë¦¬ë¥¼ ì „í•˜ê² ìŠµë‹ˆë‹¤.</p>
</section>

<div class="form-wrap">
  <div id="form-body">

    <div class="card">
      <div class="card-title">ğŸ‘¤ ë³´ë‚´ëŠ” ë¶„</div>
      <div class="row2">
        <div class="field">
          <label>ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„</label>
          <input type="text" id="f-name" placeholder="ìµëª…ë„ ê´œì°®ì•„ìš”">
        </div>
        <div class="field">
          <label>ì—°ë½ì²˜ (ì„ íƒ)</label>
          <input type="text" id="f-contact" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì „í™”ë²ˆí˜¸">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ·ï¸ ì‚¬ì—° ë¶„ë¥˜</div>
      <div class="field">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <div class="tag-grid" id="cat-tags">
          <span class="tag" onclick="selectCat(this)">ğŸ’ ì‚¬ë‘/ì—°ì• </span>
          <span class="tag" onclick="selectCat(this)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡±</span>
          <span class="tag" onclick="selectCat(this)">ğŸ¤ ìš°ì •/ì¸ê°„ê´€ê³„</span>
          <span class="tag" onclick="selectCat(this)">ğŸ’¼ ì§ì¥/í•™ì—…</span>
          <span class="tag" onclick="selectCat(this)">ğŸ’° ëˆ/ìƒí™œ</span>
          <span class="tag" onclick="selectCat(this)">ğŸŒ¿ ê±´ê°•/ë§ˆìŒ</span>
          <span class="tag" onclick="selectCat(this)">ğŸµ ì¶”ì–µ/ì¼ìƒ</span>
          <span class="tag" onclick="selectCat(this)">âœ¨ ê¸°íƒ€</span>
        </div>
      </div>
      <div class="field" style="margin-top:1rem;">
        <label>ì§€ê¸ˆ ê¸°ë¶„ (ë³µìˆ˜ ì„ íƒ)</label>
        <div class="tag-grid" id="emo-tags">
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜Š ê¸°ì¨</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜¢ ìŠ¬í””</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜° ë¶ˆì•ˆ</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜¤ ë¶„ë…¸</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸŒ¸ ê°ì‚¬</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ’« í¬ë§</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜” ì™¸ë¡œì›€</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ™ ê³ ë¯¼</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ˜­ ê·¸ë¦¬ì›€</span>
          <span class="tag" onclick="toggleEmo(this)">ğŸ¥° ì„¤ë ˜</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">âœï¸ í…ìŠ¤íŠ¸ ì‚¬ì—°</div>
      <textarea id="f-text" placeholder="ë§ˆìŒì† ì´ì•¼ê¸°ë¥¼ ììœ ë¡­ê²Œ ì¨ì£¼ì„¸ìš”...&#10;&#10;ì–´ë–¤ ì´ì•¼ê¸°ë“  ì†Œì¤‘íˆ ì½ê² ìŠµë‹ˆë‹¤."></textarea>
    </div>

    <div class="card">
      <div class="card-title">ğŸ™ï¸ ìŒì„± ì‚¬ì—°</div>
      <div class="voice-inner">
        <p class="voice-hint">ì§ì ‘ ëª©ì†Œë¦¬ë¡œ ì‚¬ì—°ì„ ì „í•˜ê³  ì‹¶ë‹¤ë©´<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒí•´ ì£¼ì„¸ìš”</p>
        <div class="voice-controls">
          <button class="btn btn-rust" id="rec-btn" onclick="toggleRec()">
            ğŸ™ï¸ <span id="rec-label">ë…¹ìŒ ì‹œì‘</span>
          </button>
          <span class="rec-timer" id="rec-timer">00:00</span>
        </div>
        <div id="audio-preview"></div>
      </div>
      <div class="upload-zone" onclick="document.getElementById('vfile').click()">
        <input type="file" id="vfile" accept="audio/*" onchange="handleFile(this)">
        <p>ğŸ“ ìŒì„± íŒŒì¼ ì²¨ë¶€ (.mp3 .wav .m4a .ogg)</p>
        <p class="fname" id="fname"></p>
      </div>
    </div>

    <button class="submit-btn" id="submit-btn" onclick="submitStory()">
      ì‚¬ì—° ì „ì†¡í•˜ê¸° âœ‰ï¸
    </button>

  </div>

  <div class="success-screen" id="success-screen">
    <div class="success-icon">ğŸ“»</div>
    <h2>ì‚¬ì—°ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤</h2>
    <p>ì†Œì¤‘í•œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ì£¼ì…”ì„œ ê°ì‚¬í•´ìš”.<br>ë°©ì†¡ì—ì„œ ì†Œê°œë  ìˆ˜ ìˆìœ¼ë‹ˆ ê¸°ëŒ€í•´ ì£¼ì„¸ìš” ğŸ¶</p>
    <br>
    <button class="btn btn-outline" style="margin:0 auto;" onclick="resetForm()">
      ìƒˆ ì‚¬ì—° ë³´ë‚´ê¸°
    </button>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
let selCat='', selEmos=[];
let recorder=null, chunks=[], recBlob=null, uploadedFile=null;
let timerInt=null, secs=0, recActive=false;

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function selectCat(el){
  document.querySelectorAll('#cat-tags .tag').forEach(t=>t.classList.remove('active'));
  el.classList.add('active'); selCat=el.textContent.trim();
}
function toggleEmo(el){
  el.classList.toggle('active');
  const t=el.textContent.trim();
  if(el.classList.contains('active')) selEmos.push(t);
  else selEmos=selEmos.filter(e=>e!==t);
}

let recognition=null;
let recognizing=false;
let accumulatedText='';

function startSpeechRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return;

  recognition = new SR();
  recognition.lang = 'ko-KR';
  recognition.continuous = false;      // ì•ˆë“œë¡œì´ë“œ í˜¸í™˜
  recognition.interimResults = true;
  recognizing = true;

  recognition.onresult = (e) => {
    let interim = '';
    for(let i=e.resultIndex; i<e.results.length; i++){
      if(e.results[i].isFinal){
        accumulatedText += e.results[i][0].transcript;
      } else {
        interim = e.results[i][0].transcript;
      }
    }
    document.getElementById('f-text').value = accumulatedText + interim;
  };

  recognition.onend = () => {
    // ë…¹ìŒ ì¤‘ì´ë©´ ìë™ìœ¼ë¡œ ì¬ì‹œì‘ (ëŠì–´ì„œ ë°˜ë³µ)
    if(recActive && recognizing){
      try{ recognition.start(); }catch(e){}
    }
  };

  recognition.onerror = (e) => {
    if(e.error === 'no-speech' && recActive && recognizing){
      try{ recognition.start(); }catch(err){}
    }
  };

  try{ recognition.start(); }catch(e){}
}

async function toggleRec(){
  if(!recActive){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      recorder=new MediaRecorder(stream); chunks=[];
      recorder.ondataavailable=e=>chunks.push(e.data);
      recorder.onstop=()=>{
        recBlob=new Blob(chunks,{type:'audio/webm'});
        const url=URL.createObjectURL(recBlob);
        document.getElementById('audio-preview').innerHTML=`<audio controls src="${url}"></audio>`;
        stream.getTracks().forEach(t=>t.stop());
      };
      recorder.start(); recActive=true;
      document.getElementById('rec-btn').classList.add('recording');
      document.getElementById('rec-label').textContent='ë…¹ìŒ ì¤‘ì§€';
      secs=0; document.getElementById('rec-timer').style.display='inline';
      timerInt=setInterval(()=>{
        secs++;
        document.getElementById('rec-timer').textContent=
          String(Math.floor(secs/60)).padStart(2,'0')+':'+String(secs%60).padStart(2,'0');
      },1000);

      // ë°›ì•„ì“°ê¸° ì‹œì‘
      accumulatedText = document.getElementById('f-text').value;
      startSpeechRecognition();

    }catch(e){alert('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');}
  }else{
    recorder.stop(); recActive=false; clearInterval(timerInt);
    document.getElementById('rec-btn').classList.remove('recording');
    document.getElementById('rec-label').textContent='ë…¹ìŒ ì‹œì‘';
    document.getElementById('rec-timer').style.display='none';
    // ë°›ì•„ì“°ê¸° ì¤‘ì§€
    recognizing=false;
    if(recognition){ try{recognition.stop();}catch(e){} recognition=null; }
  }
}

function handleFile(input){
  const f=input.files[0]; if(!f) return;
  uploadedFile=f; document.getElementById('fname').textContent='âœ… '+f.name;
}

async function submitStory(){
  const text=document.getElementById('f-text').value.trim();
  if(!text&&!recBlob&&!uploadedFile){showToast('â— í…ìŠ¤íŠ¸ ë˜ëŠ” ìŒì„± ì‚¬ì—°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  const btn=document.getElementById('submit-btn');
  btn.disabled=true; btn.innerHTML='<div class="spinner"></div> ì „ì†¡ ì¤‘...';
  const fd=new FormData();
  fd.append('name',document.getElementById('f-name').value.trim()||'ìµëª…');
  fd.append('contact',document.getElementById('f-contact').value.trim());
  fd.append('text',text); fd.append('category',selCat);
  fd.append('emotions',JSON.stringify(selEmos));
  const vs=recBlob||uploadedFile;
  if(vs){const ext=vs instanceof File?vs.name.split('.').pop():'webm'; fd.append('voice',vs,`voice.${ext}`);}
  try{
    const res=await fetch('/api/stories',{method:'POST',body:fd});
    const data=await res.json();
    if(data.success){
      document.getElementById('form-body').style.display='none';
      document.getElementById('success-screen').style.display='block';
      window.scrollTo({top:0,behavior:'smooth'});
    }else{showToast('â— '+(data.error||'ì˜¤ë¥˜'));btn.disabled=false;btn.innerHTML='ì‚¬ì—° ì „ì†¡í•˜ê¸° âœ‰ï¸';}
  }catch(e){showToast('â— ì„œë²„ ì—°ê²° ì‹¤íŒ¨');btn.disabled=false;btn.innerHTML='ì‚¬ì—° ì „ì†¡í•˜ê¸° âœ‰ï¸';}
}

function resetForm(){
  ['f-text','f-name','f-contact'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('audio-preview').innerHTML='';
  document.getElementById('fname').textContent='';
  document.querySelectorAll('.tag').forEach(t=>t.classList.remove('active'));
  selCat=''; selEmos=[]; recBlob=null; uploadedFile=null;
  const btn=document.getElementById('submit-btn');
  btn.disabled=false; btn.innerHTML='ì‚¬ì—° ì „ì†¡í•˜ê¸° âœ‰ï¸';
  document.getElementById('form-body').style.display='block';
  document.getElementById('success-screen').style.display='none';
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
