<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í†µí•© í…ŒìŠ¤íŠ¸ â€” ë¼ë””ì˜¤ ì‚¬ì—°í•¨</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080c10;--surface:#0d1117;--card:#111820;
  --border:#1e2a38;--text:#e0eaf4;--muted:#5a7a9a;
  --green:#00e676;--red:#ff4d4d;--amber:#ffc107;--cyan:#00d4ff;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:2rem 1.5rem;}
.header{text-align:center;margin-bottom:2.5rem;}
.header h1{font-family:'DM Mono',monospace;font-size:1.4rem;color:var(--cyan);margin-bottom:0.4rem;}
.header p{font-size:0.85rem;color:var(--muted);}
.target{display:flex;align-items:center;gap:0.6rem;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:0.8rem 1rem;margin-bottom:1.5rem;}
.target label{font-size:0.8rem;color:var(--muted);white-space:nowrap;}
.target input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:0.5rem 0.8rem;color:var(--text);font-family:'DM Mono',monospace;font-size:0.85rem;outline:none;}
.target input:focus{border-color:var(--cyan);}
.run-btn{padding:0.7rem 2rem;background:var(--cyan);color:#000;border:none;border-radius:8px;font-family:'Noto Sans KR',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.run-btn:hover{background:#00b8d9;}
.run-btn:disabled{opacity:0.4;cursor:not-allowed;}

.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:0.8rem;margin-bottom:1.5rem;}
.sum-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;text-align:center;}
.sum-card .n{font-family:'DM Mono',monospace;font-size:1.8rem;font-weight:500;}
.sum-card .l{font-size:0.72rem;color:var(--muted);margin-top:0.2rem;}
.n.pass{color:var(--green);}
.n.fail{color:var(--red);}
.n.skip{color:var(--amber);}
.n.total{color:var(--cyan);}

.test-list{display:flex;flex-direction:column;gap:0.6rem;}
.test-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem 1.2rem;display:flex;align-items:flex-start;gap:1rem;transition:border-color 0.3s;}
.test-item.pass{border-color:rgba(0,230,118,0.3);}
.test-item.fail{border-color:rgba(255,77,77,0.3);}
.test-item.running{border-color:rgba(0,212,255,0.3);}
.status-icon{font-size:1.2rem;min-width:24px;margin-top:1px;}
.test-info{flex:1;}
.test-name{font-size:0.9rem;font-weight:600;margin-bottom:0.2rem;}
.test-desc{font-size:0.78rem;color:var(--muted);}
.test-result{font-size:0.78rem;margin-top:0.4rem;font-family:'DM Mono',monospace;padding:0.3rem 0.6rem;border-radius:4px;display:inline-block;}
.test-result.ok{background:rgba(0,230,118,0.1);color:var(--green);}
.test-result.err{background:rgba(255,77,77,0.1);color:var(--red);}
.test-result.info{background:rgba(0,212,255,0.1);color:var(--cyan);}
.test-time{font-family:'DM Mono',monospace;font-size:0.75rem;color:var(--muted);white-space:nowrap;margin-top:2px;}

.spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(0,212,255,0.3);border-top-color:var(--cyan);border-radius:50%;animation:spin 0.7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

.log-area{margin-top:1.5rem;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;}
.log-area h3{font-size:0.75rem;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:0.8rem;}
.log-lines{font-family:'DM Mono',monospace;font-size:0.78rem;line-height:1.7;max-height:200px;overflow-y:auto;}
.log-ok{color:var(--green);}
.log-err{color:var(--red);}
.log-info{color:var(--cyan);}
.log-warn{color:var(--amber);}

@media(max-width:600px){
  .summary{grid-template-columns:repeat(2,1fr);}
  .target{flex-direction:column;align-items:stretch;}
}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸</h1>
  <p>ë¼ë””ì˜¤ ì‚¬ì—°í•¨ â€” ì „ì²´ ê¸°ëŠ¥ ìë™ ê²€ì¦</p>
</div>

<div class="target">
  <label>ì„œë²„ ì£¼ì†Œ</label>
  <input type="text" id="base-url" value="https://radio-story-app-production.up.railway.app">
  <button class="run-btn" id="run-btn" onclick="runAll()">â–¶ ì „ì²´ ì‹¤í–‰</button>
</div>

<div class="summary">
  <div class="sum-card"><div class="n total" id="s-total">0</div><div class="l">ì „ì²´</div></div>
  <div class="sum-card"><div class="n pass" id="s-pass">0</div><div class="l">í†µê³¼ âœ…</div></div>
  <div class="sum-card"><div class="n fail" id="s-fail">0</div><div class="l">ì‹¤íŒ¨ âŒ</div></div>
  <div class="sum-card"><div class="n skip" id="s-skip">0</div><div class="l">ëŒ€ê¸° â³</div></div>
</div>

<div class="test-list" id="test-list"></div>

<div class="log-area">
  <h3>ì‹¤í–‰ ë¡œê·¸</h3>
  <div class="log-lines" id="log"></div>
</div>

<script>
const TESTS = [
  {
    id: 'server',
    name: 'ì„œë²„ ì‘ë‹µ í™•ì¸',
    desc: 'ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸',
    run: async (base) => {
      const res = await fetch(base, { signal: AbortSignal.timeout(8000) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return `HTTP ${res.status} OK`;
    }
  },
  {
    id: 'admin',
    name: 'ê´€ë¦¬ì í˜ì´ì§€ ì‘ë‹µ',
    desc: '/admin í˜ì´ì§€ê°€ ì •ìƒ ë¡œë“œë˜ëŠ”ì§€ í™•ì¸',
    run: async (base) => {
      const res = await fetch(`${base}/admin`, { signal: AbortSignal.timeout(8000) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return `HTTP ${res.status} OK`;
    }
  },
  {
    id: 'stats',
    name: 'API í†µê³„ ì¡°íšŒ',
    desc: '/api/stats ì—”ë“œí¬ì¸íŠ¸ ì •ìƒ ì‘ë‹µ í™•ì¸',
    run: async (base) => {
      const res = await fetch(`${base}/api/stats`, { signal: AbortSignal.timeout(8000) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();
      if(typeof d.total !== 'number') throw new Error('ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
      return `ì „ì²´ ${d.total}ê±´ / ì˜¤ëŠ˜ ${d.todayCount}ê±´`;
    }
  },
  {
    id: 'stories-get',
    name: 'API ì‚¬ì—° ëª©ë¡ ì¡°íšŒ',
    desc: '/api/stories ì—”ë“œí¬ì¸íŠ¸ ì •ìƒ ì‘ë‹µ í™•ì¸',
    run: async (base) => {
      const res = await fetch(`${base}/api/stories?limit=5`, { signal: AbortSignal.timeout(8000) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();
      if(!Array.isArray(d.items)) throw new Error('ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
      return `${d.items.length}ê±´ ì¡°íšŒë¨`;
    }
  },
  {
    id: 'story-post',
    name: 'API í…ìŠ¤íŠ¸ ì‚¬ì—° ì œì¶œ',
    desc: 'í…ìŠ¤íŠ¸ ì‚¬ì—°ì„ ì‹¤ì œë¡œ ì œì¶œí•˜ê³  ì €ì¥ í™•ì¸',
    run: async (base) => {
      const fd = new FormData();
      fd.append('name', 'í…ŒìŠ¤íŠ¸ë´‡');
      fd.append('text', `[ìë™í…ŒìŠ¤íŠ¸] ${new Date().toLocaleString('ko-KR')} â€” ì´ ì‚¬ì—°ì€ í†µí•© í…ŒìŠ¤íŠ¸ê°€ ìë™ ìƒì„±í–ˆìŠµë‹ˆë‹¤.`);
      fd.append('category', 'âœ¨ ê¸°íƒ€');
      fd.append('emotions', JSON.stringify(['ğŸ’« í¬ë§']));
      const res = await fetch(`${base}/api/stories`, { method:'POST', body:fd, signal: AbortSignal.timeout(10000) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();
      if(!d.success) throw new Error(d.error || 'ì œì¶œ ì‹¤íŒ¨');
      window._testStoryId = d.id;
      return `ì‚¬ì—° ID: ${d.id.slice(0,8)}...`;
    }
  },
  {
    id: 'story-verify',
    name: 'DB ì €ì¥ í™•ì¸',
    desc: 'ì œì¶œí•œ ì‚¬ì—°ì´ DBì— ì‹¤ì œë¡œ ì €ì¥ëëŠ”ì§€ í™•ì¸',
    run: async (base) => {
      if(!window._testStoryId) throw new Error('ì´ì „ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¡œ ê±´ë„ˆëœ€');
      await new Promise(r => setTimeout(r, 1000));
      const res = await fetch(`${base}/api/stories?limit=10`, { signal: AbortSignal.timeout(8000) });
      const d = await res.json();
      const found = d.items.find(s => s.id === window._testStoryId);
      if(!found) throw new Error('DBì—ì„œ ì‚¬ì—°ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      return `DB ì €ì¥ í™•ì¸ ì™„ë£Œ â€” "${found.name}"`;
    }
  },
  {
    id: 'story-delete',
    name: 'í…ŒìŠ¤íŠ¸ ì‚¬ì—° ì‚­ì œ',
    desc: 'í…ŒìŠ¤íŠ¸ìš© ì‚¬ì—°ì„ ì •ë¦¬ (ì‚­ì œ API í™•ì¸)',
    run: async (base) => {
      if(!window._testStoryId) throw new Error('ì‚­ì œí•  ì‚¬ì—° ì—†ìŒ');
      const res = await fetch(`${base}/api/stories/${window._testStoryId}`, { method:'DELETE', signal: AbortSignal.timeout(8000) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();
      if(!d.success) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
      return 'í…ŒìŠ¤íŠ¸ ì‚¬ì—° ì‚­ì œ ì™„ë£Œ';
    }
  },
  {
    id: 'supabase',
    name: 'Supabase ì—°ê²° ìƒíƒœ',
    desc: 'DB ì‘ë‹µ ì†ë„ ë° ì—°ê²° ì•ˆì •ì„± í™•ì¸',
    run: async (base) => {
      const start = Date.now();
      const res = await fetch(`${base}/api/stats`, { signal: AbortSignal.timeout(8000) });
      const ms = Date.now() - start;
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      if(ms > 5000) throw new Error(`ì‘ë‹µ ë„ˆë¬´ ëŠë¦¼: ${ms}ms`);
      return `ì‘ë‹µì†ë„ ${ms}ms ${ms < 1000 ? 'ğŸŸ¢ ë¹ ë¦„' : ms < 3000 ? 'ğŸŸ¡ ë³´í†µ' : 'ğŸ”´ ëŠë¦¼'}`;
    }
  },
  {
    id: 'voice-upload',
    name: 'Supabase Storage ìŒì„± ì—…ë¡œë“œ',
    desc: 'ìŒì„± íŒŒì¼ì„ ì‹¤ì œë¡œ ì—…ë¡œë“œí•˜ê³  URL í™•ì¸',
    run: async (base) => {
      // ì§§ì€ ë¬´ìŒ WebM blob ìƒì„±
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.5, audioCtx.sampleRate);
      const source = audioCtx.createBufferSource();
      source.buffer = buffer;

      // MediaRecorderë¡œ blob ìƒì„±
      const dest = audioCtx.createMediaStreamDestination();
      source.connect(dest);
      source.start();

      const rec = new MediaRecorder(dest.stream);
      const chunks = [];
      rec.ondataavailable = e => chunks.push(e.data);
      rec.start();
      await new Promise(r => setTimeout(r, 600));
      rec.stop();
      await new Promise(r => rec.onstop = r);
      audioCtx.close();

      const blob = new Blob(chunks, { type: 'audio/webm' });
      const fd = new FormData();
      fd.append('name', 'í…ŒìŠ¤íŠ¸ë´‡');
      fd.append('text', '');
      fd.append('category', 'âœ¨ ê¸°íƒ€');
      fd.append('emotions', '[]');
      fd.append('voice', blob, 'test.webm');

      const res = await fetch(`${base}/api/stories`, { method:'POST', body:fd, signal: AbortSignal.timeout(15000) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();
      if(!d.success) throw new Error(d.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
      window._testVoiceId = d.id;

      // ì €ì¥ëœ URL í™•ì¸
      await new Promise(r => setTimeout(r, 1000));
      const listRes = await fetch(`${base}/api/stories?limit=5`);
      const list = await listRes.json();
      const found = list.items.find(s => s.id === d.id);
      if(!found) throw new Error('ì €ì¥ í™•ì¸ ì‹¤íŒ¨');
      if(!found.voiceUrl) throw new Error('Storage URL ì—†ìŒ');

      // í…ŒìŠ¤íŠ¸ ì‚¬ì—° ì‚­ì œ
      await fetch(`${base}/api/stories/${d.id}`, { method:'DELETE' });

      return `Storage URL í™•ì¸ ì™„ë£Œ`;
    }
  },
  {
    id: 'speech',
    name: 'ë¸Œë¼ìš°ì € ë°›ì•„ì“°ê¸° ì§€ì›',
    desc: 'SpeechRecognition API ì§€ì› ì—¬ë¶€ í™•ì¸',
    run: async (base) => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) throw new Error('ì´ ë¸Œë¼ìš°ì €ëŠ” ë°›ì•„ì“°ê¸° ë¯¸ì§€ì›');
      return 'ë°›ì•„ì“°ê¸° API ì§€ì›ë¨ âœ…';
    }
  },
  {
    id: 'mic',
    name: 'ë§ˆì´í¬ ê¶Œí•œ í™•ì¸',
    desc: 'ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í—ˆìš©ë¼ ìˆëŠ”ì§€ í™•ì¸',
    run: async (base) => {
      const result = await navigator.permissions.query({ name: 'microphone' });
      if(result.state === 'denied') throw new Error('ë§ˆì´í¬ ê¶Œí•œ ê±°ë¶€ë¨');
      if(result.state === 'prompt') return 'ê¶Œí•œ ë¯¸ê²°ì • (ì²« ì‚¬ìš© ì‹œ í—ˆìš© í•„ìš”)';
      return `ë§ˆì´í¬ ê¶Œí•œ: ${result.state}`;
    }
  },
];

let results = {};

function log(msg, type='info'){
  const el = document.getElementById('log');
  const line = document.createElement('div');
  const time = new Date().toLocaleTimeString('ko-KR');
  line.className = `log-${type}`;
  line.textContent = `[${time}] ${msg}`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

function updateSummary(){
  const pass = Object.values(results).filter(r=>r==='pass').length;
  const fail = Object.values(results).filter(r=>r==='fail').length;
  const total = TESTS.length;
  const skip = total - pass - fail;
  document.getElementById('s-total').textContent = total;
  document.getElementById('s-pass').textContent = pass;
  document.getElementById('s-fail').textContent = fail;
  document.getElementById('s-skip').textContent = skip;
}

function renderTests(){
  const list = document.getElementById('test-list');
  list.innerHTML = TESTS.map(t => `
    <div class="test-item" id="item-${t.id}">
      <div class="status-icon" id="icon-${t.id}">â³</div>
      <div class="test-info">
        <div class="test-name">${t.name}</div>
        <div class="test-desc">${t.desc}</div>
        <div id="result-${t.id}"></div>
      </div>
      <div class="test-time" id="time-${t.id}"></div>
    </div>
  `).join('');
}

function setRunning(id){
  document.getElementById(`icon-${id}`).innerHTML = '<div class="spinner"></div>';
  document.getElementById(`item-${id}`).className = 'test-item running';
}

function setPass(id, msg, ms){
  document.getElementById(`icon-${id}`).textContent = 'âœ…';
  document.getElementById(`item-${id}`).className = 'test-item pass';
  document.getElementById(`result-${id}`).innerHTML = `<span class="test-result ok">${msg}</span>`;
  document.getElementById(`time-${id}`).textContent = `${ms}ms`;
  results[id] = 'pass';
}

function setFail(id, msg, ms){
  document.getElementById(`icon-${id}`).textContent = 'âŒ';
  document.getElementById(`item-${id}`).className = 'test-item fail';
  document.getElementById(`result-${id}`).innerHTML = `<span class="test-result err">${msg}</span>`;
  document.getElementById(`time-${id}`).textContent = ms ? `${ms}ms` : '';
  results[id] = 'fail';
}

async function runAll(){
  const base = document.getElementById('base-url').value.replace(/\/$/, '');
  const btn = document.getElementById('run-btn');
  btn.disabled = true; btn.textContent = 'ì‹¤í–‰ ì¤‘...';
  results = {};
  document.getElementById('log').innerHTML = '';
  renderTests();
  updateSummary();

  log(`í…ŒìŠ¤íŠ¸ ì‹œì‘ â€” ëŒ€ìƒ: ${base}`, 'info');

  for(const test of TESTS){
    setRunning(test.id);
    log(`[${test.name}] ì‹¤í–‰ ì¤‘...`, 'info');
    const start = Date.now();
    try{
      const msg = await test.run(base);
      const ms = Date.now() - start;
      setPass(test.id, msg, ms);
      log(`[${test.name}] âœ… ${msg} (${ms}ms)`, 'ok');
    }catch(e){
      const ms = Date.now() - start;
      setFail(test.id, e.message, ms);
      log(`[${test.name}] âŒ ${e.message}`, 'err');
    }
    updateSummary();
    await new Promise(r => setTimeout(r, 300));
  }

  const pass = Object.values(results).filter(r=>r==='pass').length;
  const fail = Object.values(results).filter(r=>r==='fail').length;
  log(`í…ŒìŠ¤íŠ¸ ì™„ë£Œ â€” í†µê³¼: ${pass} / ì‹¤íŒ¨: ${fail}`, fail > 0 ? 'warn' : 'ok');
  btn.disabled = false;
  btn.textContent = 'â–¶ ë‹¤ì‹œ ì‹¤í–‰';
}

renderTests();
updateSummary();
</script>
</body>
</html>
